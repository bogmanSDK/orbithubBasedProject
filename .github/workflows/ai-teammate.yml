name: AI Teammate

on:
  # Trigger manually from GitHub UI
  workflow_dispatch:
    inputs:
      ticket_key:
        description: 'Jira ticket key (e.g., AIH-1)'
        required: true
        type: string
      
  # Trigger via webhook from Jira Automation
  repository_dispatch:
    types: [ai-teammate-trigger]

jobs:
  process-ticket:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      
      - name: ðŸ“š Install dependencies
        run: dart pub get
      
      - name: ðŸ”¨ Generate code (JSON serialization + MCP tools)
        run: |
          # Generate JSON serialization files
          dart run build_runner build --delete-conflicting-outputs
          # Generate MCP tool files
          dart run tool/generate_mcp_files.dart
      
      - name: ðŸ”§ Setup environment
        env:
          JIRA_BASE_PATH: ${{ secrets.JIRA_BASE_PATH }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          # Validate required secrets
          if [ -z "$JIRA_BASE_PATH" ]; then
            echo "âŒ Error: JIRA_BASE_PATH secret is not set"
            exit 1
          fi
          if [ -z "$JIRA_EMAIL" ]; then
            echo "âŒ Error: JIRA_EMAIL secret is not set"
            exit 1
          fi
          if [ -z "$JIRA_API_TOKEN" ]; then
            echo "âŒ Error: JIRA_API_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "$AI_API_KEY" ]; then
            echo "âš ï¸  Warning: AI_API_KEY secret is not set"
            echo "âš ï¸  AI features will be disabled"
          fi
          
          # Create .env file
          echo "JIRA_BASE_PATH=$JIRA_BASE_PATH" >> .env
          echo "JIRA_EMAIL=$JIRA_EMAIL" >> .env
          echo "JIRA_API_TOKEN=$JIRA_API_TOKEN" >> .env
          echo "AI_PROVIDER=${AI_PROVIDER:-openai}" >> .env
          echo "AI_API_KEY=$AI_API_KEY" >> .env
          echo "âœ… Environment configured"
      
      - name: ðŸ¤– Run AI Teammate
        env:
          JIRA_BASE_PATH: ${{ secrets.JIRA_BASE_PATH }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          DISABLE_JIRA_COMMENTS: 'true'
        run: |
          # Get ticket key from either manual trigger or webhook
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TICKET_KEY="${{ github.event.inputs.ticket_key }}"
          else
            TICKET_KEY="${{ github.event.client_payload.ticket_key }}"
          fi
          
          if [ -z "$TICKET_KEY" ]; then
            echo "âŒ Error: Ticket key is empty"
            echo "Event name: ${{ github.event_name }}"
            echo "Available inputs: ${{ toJSON(github.event.inputs) }}"
            echo "Available client_payload: ${{ toJSON(github.event.client_payload) }}"
            exit 1
          fi
          
          echo "ðŸŽ¯ Processing ticket: $TICKET_KEY"
          dart run bin/ai_teammate.dart "$TICKET_KEY"
      
      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "### AI Teammate Workflow Complete ðŸ¤–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TICKET_KEY="${{ github.event.inputs.ticket_key }}"
          else
            TICKET_KEY="${{ github.event.client_payload.ticket_key }}"
          fi
          echo "**Ticket**: $TICKET_KEY" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY


